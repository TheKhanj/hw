#!/usr/bin/env sh

setup_network() {
	./common/setup-eth0-udev-rules "f8:32:e4:9c:7a:33"
	./common/assert-avahi-daemon
	./common/setup-br0 "192.168.40.202"
}

setup_nas() {
	apt install -y nfs-kernel-server rpcbind
	perl -pi -e 's/^OPTIONS/#OPTIONS/' /etc/default/rpcbind
	echo "rpcbind: 192.168.40." >>/etc/hosts.allow
	systemctl restart rpcbind.service

	echo "/example 192.168.40.0/255.255.255.0(rw,no_root_squash,subtree_check)" >>/etc/exports
	exportfs -a
	/etc/init.d/nfs-kernel-server reload
}

setup_locale() {
	tee /etc/default/locale <<-EOF
		#  File generated by update-locale
		LANG="en_US.UTF-8"
		LANGUAGE="en_US:en"
	EOF

	apt install -y locales
	echo 'en_US.UTF-8 UTF-8' >>/etc/locale.gen
	locale-gen
}

setup_time() {
	dpkg-reconfigure tzdata

	apt-get install -y chrony
}

setup_fstab() {
	tee /etc/fstab <<-EOF
		UUID=73e02b82-9a27-4fcb-b849-3f37185b8e5d /         f2fs  rw,noatime,norelatime,nostrictatime 0 1
		UUID=98A7-E434                            /boot/efi vfat  rw,noatime,norelatime,nostrictatime 0 2
		tmpfs                                     /tmp      tmpfs defaults,noatime,nosuid             0 0
		tmpfs                                     /var/log  tmpfs defaults,noatime,nosuid             0 0
		UUID=ba144ea2-0bbb-41a3-9cd4-cbed25a7888c /mnt/dvr  ext4  rw,noatime,norelatime,nostrictatime 0 0
	EOF
}

setup_journald() {
	local file=/etc/systemd/journald.conf

	sed -i 's/^#Storage.*/Storage=volatile/' "$file"
	sed -i 's/^#SystemMaxUse.*/SystemMaxUse=32M/' "$file"
	sed -i 's/^#RuntimeMaxUse.*/RuntimeMaxUse=32M/' "$file"
}

setup_network
setup_nas
setup_locale
setup_time
setup_fstab
setup_journald
